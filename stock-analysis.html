<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Analysis - Dual API (Polygon.io + FMP)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f2e 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.05));
      border-radius: 20px;
      border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #a8b2d1;
    }

    .api-config {
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }

    .api-row {
      display: grid;
      grid-template-columns: 150px 1fr auto auto;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }

    .api-label {
      font-weight: 600;
      color: #a8b2d1;
    }

    .api-input {
      padding: 12px 20px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
    }

    .btn {
      padding: 12px 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #2ed573, #26d0ce);
    }

    .status {
      margin-top: 10px;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .status.success {
      background: rgba(46, 213, 115, 0.2);
      border: 1px solid rgba(46, 213, 115, 0.5);
      color: #2ed573;
    }

    .status.error {
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.5);
      color: #ff6b6b;
    }

    .status.info {
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid rgba(102, 126, 234, 0.5);
      color: #667eea;
    }

    .search-section {
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .search-box {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .search-box input {
      flex: 1;
      padding: 15px 25px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      color: white;
      font-size: 1.1rem;
    }

    .search-box button {
      padding: 15px 40px;
      font-size: 1.1rem;
    }

    .time-range-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .time-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .time-btn:hover,
    .time-btn.active {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.2));
      border-color: #667eea;
    }

    .stock-header {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.1));
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .stock-title {
      font-size: 2rem;
      color: #a8b2d1;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .company-name {
      font-size: 1.2rem;
      color: rgba(255,255,255,0.6);
      font-weight: normal;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .metric-card {
      background: rgba(0,0,0,0.3);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .metric-label {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #a8b2d1;
    }

    .metric-change {
      font-size: 1rem;
      margin-top: 5px;
    }

    .positive {
      color: #2ed573;
    }

    .negative {
      color: #ff6b6b;
    }

    .chart-container {
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .chart-wrapper {
      position: relative;
      height: 500px;
    }

    .financials-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .financial-card {
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .financial-card h3 {
      color: #a8b2d1;
      margin-bottom: 20px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .financial-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .financial-row:last-child {
      border-bottom: none;
    }

    .financial-label {
      color: rgba(255,255,255,0.7);
    }

    .financial-value {
      font-weight: 600;
      color: #a8b2d1;
    }

    .financial-value.highlight {
      font-size: 1.1rem;
      color: #667eea;
    }

    .ratios-section {
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .ratios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-top: 20px;
    }

    .ratio-category h4 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .ratio-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #667eea;
      font-size: 1.2rem;
    }

    .spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(102, 126, 234, 0.3);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-msg {
      background: rgba(255, 107, 107, 0.2);
      border: 2px solid #ff6b6b;
      border-radius: 12px;
      padding: 20px;
      color: #ff6b6b;
      margin: 20px 0;
    }

    .cache-indicator {
      background: rgba(46, 213, 115, 0.1);
      border: 1px solid rgba(46, 213, 115, 0.3);
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 0.85rem;
      color: #2ed573;
      display: inline-block;
      margin-left: 15px;
    }

    .info-box {
      background: rgba(102, 126, 234, 0.1);
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üìä Comprehensive Stock Analysis</h1>
      <p style="color: rgba(255,255,255,0.7); font-size: 1.1rem;">
        Real-time data from Polygon.io ‚Ä¢ Financial statements from FMP ‚Ä¢ Smart 24-hour caching
      </p>
    </div>

    <!-- API Configuration -->
    <div class="api-config">
      <h2 style="color: #a8b2d1; margin-bottom: 20px;">üîë API Configuration</h2>
      
      <div class="api-row">
        <div class="api-label">Polygon.io:</div>
        <input type="text" class="api-input" id="polygonKey" placeholder="Enter Polygon.io API key">
        <button class="btn" onclick="savePolygonKey()">üíæ Save</button>
        <button class="btn btn-success" onclick="testPolygonKey()">‚úì Test</button>
      </div>
      
      <div class="api-row">
        <div class="api-label">FMP:</div>
        <input type="text" class="api-input" id="fmpKey" placeholder="Enter Financial Modeling Prep API key">
        <button class="btn" onclick="saveFMPKey()">üíæ Save</button>
        <button class="btn btn-success" onclick="testFMPKey()">‚úì Test</button>
      </div>

      <div id="apiStatus"></div>

      <div class="info-box" style="margin-top: 20px;">
        <strong>üìå Get FREE API Keys:</strong><br>
        ‚Ä¢ <strong>Polygon.io</strong>: <a href="https://polygon.io/dashboard/signup" target="_blank" style="color: #667eea;">polygon.io/dashboard/signup</a> (Unlimited calls, 5/min rate limit)<br>
        ‚Ä¢ <strong>FMP</strong>: <a href="https://site.financialmodelingprep.com/developer/docs" target="_blank" style="color: #667eea;">financialmodelingprep.com</a> (250 calls/day, 24-hour cache enabled)
      </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
      <h2 style="margin-bottom: 20px; color: #a8b2d1;">üîç Analyze Stock</h2>
      <div class="search-box">
        <input type="text" id="symbolInput" placeholder="Enter stock symbol (e.g., AAPL, TSLA, MSFT, GOOGL, NVDA)..." onkeypress="if(event.key==='Enter') analyzeStock()">
        <button class="btn" onclick="analyzeStock()">Analyze Stock</button>
      </div>
      
      <div class="time-range-selector">
        <button class="time-btn" onclick="changeTimeRange('1D')">1 Day</button>
        <button class="time-btn active" onclick="changeTimeRange('1W')">1 Week</button>
        <button class="time-btn" onclick="changeTimeRange('1M')">1 Month</button>
        <button class="time-btn" onclick="changeTimeRange('3M')">3 Months</button>
        <button class="time-btn" onclick="changeTimeRange('1Y')">1 Year</button>
        <button class="time-btn" onclick="changeTimeRange('2Y')">2 Years</button>
      </div>
    </div>

    <!-- Stock Header -->
    <div id="stockHeader" style="display: none;"></div>

    <!-- Chart Container -->
    <div id="chartContainer" style="display: none;">
      <div class="chart-container">
        <h3 style="margin-bottom: 20px; color: #a8b2d1;">
          üìà Price Chart (Polygon.io)
          <span id="chartCache"></span>
        </h3>
        <div class="chart-wrapper">
          <canvas id="priceChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Financial Statements -->
    <div id="financialsContainer" style="display: none;">
      <h2 style="color: #a8b2d1; margin-bottom: 20px;">
        üí∞ Financial Statements (FMP)
        <span id="financialsCache"></span>
      </h2>
      <div class="financials-section" id="financialStatements"></div>
    </div>

    <!-- Financial Ratios -->
    <div id="ratiosContainer" style="display: none;">
      <div class="ratios-section">
        <h2 style="color: #a8b2d1; margin-bottom: 10px;">
          üìä Financial Ratios & Metrics (FMP)
          <span id="ratiosCache"></span>
        </h2>
        <div class="ratios-grid" id="ratiosGrid"></div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Fetching comprehensive stock data...</p>
      <p style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 10px;">
        This may take a few seconds for the first fetch. Data will be cached for 24 hours.
      </p>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay"></div>
  </div>

  <script>
    // ============================================
    // API KEY MANAGEMENT
    // ============================================
    
    let polygonKey = localStorage.getItem('polygon_api_key') || '';
    let fmpKey = localStorage.getItem('fmp_api_key') || '';
    let currentSymbol = '';
    let currentTimeRange = '1W';
    let priceChart = null;

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      if (polygonKey) {
        document.getElementById('polygonKey').value = polygonKey;
        showStatus('‚úÖ Polygon.io API key loaded', 'success');
      }
      if (fmpKey) {
        document.getElementById('fmpKey').value = fmpKey;
      }
    });

    // Save Polygon.io Key
    function savePolygonKey() {
      const input = document.getElementById('polygonKey');
      polygonKey = input.value.trim();
      
      if (!polygonKey) {
        showStatus('‚ùå Please enter a Polygon.io API key', 'error');
        return;
      }
      
      localStorage.setItem('polygon_api_key', polygonKey);
      showStatus('‚úÖ Polygon.io API key saved!', 'success');
    }

    // Save FMP Key
    function saveFMPKey() {
      const input = document.getElementById('fmpKey');
      fmpKey = input.value.trim();
      
      if (!fmpKey) {
        showStatus('‚ùå Please enter an FMP API key', 'error');
        return;
      }
      
      localStorage.setItem('fmp_api_key', fmpKey);
      showStatus('‚úÖ FMP API key saved!', 'success');
    }

    // Test Polygon.io Key
    async function testPolygonKey() {
      if (!polygonKey) {
        showStatus('‚ùå Please save Polygon.io API key first', 'error');
        return;
      }

      showStatus('üîÑ Testing Polygon.io API key...', 'info');
      
      try {
        const response = await fetch(
          `https://api.polygon.io/v3/reference/tickers/AAPL?apiKey=${polygonKey}`
        );
        const data = await response.json();
        
        if (data.status === 'OK' && data.results) {
          showStatus('‚úÖ Polygon.io API key is valid!', 'success');
        } else {
          showStatus('‚ùå Polygon.io API key invalid: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('‚ùå Network error: ' + error.message, 'error');
      }
    }

    // Test FMP Key
    async function testFMPKey() {
      if (!fmpKey) {
        showStatus('‚ùå Please save FMP API key first', 'error');
        return;
      }

      showStatus('üîÑ Testing FMP API key...', 'info');
      
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/quote/AAPL?apikey=${fmpKey}`
        );
        const data = await response.json();
        
        if (Array.isArray(data) && data.length > 0) {
          showStatus('‚úÖ FMP API key is valid!', 'success');
        } else if (data.error) {
          showStatus('‚ùå FMP API key invalid: ' + data.error, 'error');
        } else {
          showStatus('‚ùå FMP API key invalid', 'error');
        }
      } catch (error) {
        showStatus('‚ùå Network error: ' + error.message, 'error');
      }
    }

    // Show Status
    function showStatus(message, type) {
      const statusEl = document.getElementById('apiStatus');
      statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // ============================================
    // CACHING SYSTEM (24 HOURS)
    // ============================================
    
    function getCacheKey(symbol, dataType) {
      return `cache_${symbol}_${dataType}`;
    }

    function getCachedData(symbol, dataType) {
      const cacheKey = getCacheKey(symbol, dataType);
      const cached = localStorage.getItem(cacheKey);
      
      if (!cached) return null;
      
      try {
        const data = JSON.parse(cached);
        const now = Date.now();
        const age = now - data.timestamp;
        const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;
        
        if (age < TWENTY_FOUR_HOURS) {
          console.log(`‚úÖ Using cached ${dataType} for ${symbol} (${Math.round(age/1000/60)} min old)`);
          return data.value;
        } else {
          console.log(`‚ùå Cache expired for ${symbol} ${dataType}`);
          localStorage.removeItem(cacheKey);
          return null;
        }
      } catch (e) {
        return null;
      }
    }

    function setCachedData(symbol, dataType, value) {
      const cacheKey = getCacheKey(symbol, dataType);
      const data = {
        timestamp: Date.now(),
        value: value
      };
      localStorage.setItem(cacheKey, JSON.stringify(data));
      console.log(`üíæ Cached ${dataType} for ${symbol}`);
    }

    function showCacheIndicator(elementId, isCached) {
      const el = document.getElementById(elementId);
      if (el) {
        if (isCached) {
          el.innerHTML = '<span class="cache-indicator">üì¶ From Cache (24hr)</span>';
        } else {
          el.innerHTML = '<span class="cache-indicator" style="background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.3); color: #667eea;">üîÑ Fresh Data</span>';
        }
      }
    }

    // ============================================
    // TIME RANGE
    // ============================================
    
    function changeTimeRange(range) {
      currentTimeRange = range;
      
      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (currentSymbol) {
        fetchChartData(currentSymbol, range);
      }
    }

    // ============================================
    // MAIN ANALYSIS FUNCTION
    // ============================================
    
    async function analyzeStock() {
      const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
      
      if (!symbol) {
        showError('Please enter a stock symbol');
        return;
      }
      
      if (!polygonKey || !fmpKey) {
        showError('Please configure both API keys first');
        return;
      }
      
      currentSymbol = symbol;
      showLoading(true);
      hideError();
      
      try {
        // Fetch all data in parallel
        const [polygonData, fmpQuote, incomeData, balanceData, cashFlowData, ratiosData] = await Promise.all([
          fetchPolygonQuote(symbol),
          fetchFMPQuote(symbol),
          fetchIncomeStatement(symbol),
          fetchBalanceSheet(symbol),
          fetchCashFlow(symbol),
          fetchRatios(symbol)
        ]);
        
        // Display stock header
        displayStockHeader(polygonData, fmpQuote);
        
        // Display chart
        await fetchChartData(symbol, currentTimeRange);
        
        // Display financials
        displayFinancialStatements(incomeData, balanceData, cashFlowData);
        
        // Display ratios
        displayRatios(ratiosData);
        
        showLoading(false);
        
      } catch (error) {
        showLoading(false);
        showError(error.message);
        console.error('Error:', error);
      }
    }

    // ============================================
    // POLYGON.IO API CALLS
    // ============================================
    
    async function fetchPolygonQuote(symbol) {
      try {
        const response = await fetch(
          `https://api.polygon.io/v2/aggs/ticker/${symbol}/prev?adjusted=true&apiKey=${polygonKey}`
        );
        const data = await response.json();
        
        if (data.status === 'ERROR' || !data.results || data.results.length === 0) {
          throw new Error('Symbol not found on Polygon.io');
        }
        
        return data.results[0];
      } catch (error) {
        throw new Error('Polygon.io error: ' + error.message);
      }
    }

    async function fetchChartData(symbol, timeRange) {
      const dateRange = getDateRange(timeRange);
      const timespan = timeRange === '1D' ? 'minute' : 'day';
      const multiplier = timeRange === '1D' ? 5 : 1;
      
      try {
        const response = await fetch(
          `https://api.polygon.io/v2/aggs/ticker/${symbol}/range/${multiplier}/${timespan}/${dateRange.from}/${dateRange.to}?adjusted=true&sort=asc&limit=5000&apiKey=${polygonKey}`
        );
        const data = await response.json();
        
        if (data.status === 'ERROR' || !data.results || data.results.length === 0) {
          throw new Error('No chart data available');
        }
        
        displayChart(data.results, timeRange);
        showCacheIndicator('chartCache', false);
        
      } catch (error) {
        showError('Chart error: ' + error.message);
      }
    }

    function getDateRange(range) {
      const today = new Date();
      const from = new Date();
      
      switch(range) {
        case '1D': from.setDate(today.getDate() - 1); break;
        case '1W': from.setDate(today.getDate() - 7); break;
        case '1M': from.setMonth(today.getMonth() - 1); break;
        case '3M': from.setMonth(today.getMonth() - 3); break;
        case '1Y': from.setFullYear(today.getFullYear() - 1); break;
        case '2Y': from.setFullYear(today.getFullYear() - 2); break;
      }
      
      return {
        from: from.toISOString().split('T')[0],
        to: today.toISOString().split('T')[0]
      };
    }

    // ============================================
    // FMP API CALLS WITH CACHING
    // ============================================
    
    async function fetchFMPQuote(symbol) {
      // Check cache first
      const cached = getCachedData(symbol, 'quote');
      if (cached) return cached;
      
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/quote/${symbol}?apikey=${fmpKey}`
        );
        const data = await response.json();
        
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('Symbol not found on FMP');
        }
        
        const quote = data[0];
        setCachedData(symbol, 'quote', quote);
        return quote;
        
      } catch (error) {
        throw new Error('FMP quote error: ' + error.message);
      }
    }

    async function fetchIncomeStatement(symbol) {
      // Check cache first
      const cached = getCachedData(symbol, 'income');
      if (cached) {
        showCacheIndicator('financialsCache', true);
        return cached;
      }
      
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/income-statement/${symbol}?limit=5&apikey=${fmpKey}`
        );
        const data = await response.json();
        
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('No income statement data');
        }
        
        setCachedData(symbol, 'income', data);
        showCacheIndicator('financialsCache', false);
        return data;
        
      } catch (error) {
        console.error('Income statement error:', error);
        return [];
      }
    }

    async function fetchBalanceSheet(symbol) {
      // Check cache first
      const cached = getCachedData(symbol, 'balance');
      if (cached) return cached;
      
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/balance-sheet-statement/${symbol}?limit=5&apikey=${fmpKey}`
        );
        const data = await response.json();
        
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('No balance sheet data');
        }
        
        setCachedData(symbol, 'balance', data);
        return data;
        
      } catch (error) {
        console.error('Balance sheet error:', error);
        return [];
      }
    }

    async function fetchCashFlow(symbol) {
      // Check cache first
      const cached = getCachedData(symbol, 'cashflow');
      if (cached) return cached;
      
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/cash-flow-statement/${symbol}?limit=5&apikey=${fmpKey}`
        );
        const data = await response.json();
        
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('No cash flow data');
        }
        
        setCachedData(symbol, 'cashflow', data);
        return data;
        
      } catch (error) {
        console.error('Cash flow error:', error);
        return [];
      }
    }

    async function fetchRatios(symbol) {
      // Check cache first
      const cached = getCachedData(symbol, 'ratios');
      if (cached) {
        showCacheIndicator('ratiosCache', true);
        return cached;
      }
      
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/ratios/${symbol}?limit=1&apikey=${fmpKey}`
        );
        const data = await response.json();
        
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('No ratios data');
        }
        
        setCachedData(symbol, 'ratios', data[0]);
        showCacheIndicator('ratiosCache', false);
        return data[0];
        
      } catch (error) {
        console.error('Ratios error:', error);
        return null;
      }
    }

    // ============================================
    // DISPLAY FUNCTIONS
    // ============================================
    
    function displayStockHeader(polygonData, fmpQuote) {
      const currentPrice = polygonData.c;
      const change = polygonData.c - polygonData.o;
      const changePercent = ((change / polygonData.o) * 100).toFixed(2);
      
      const changeClass = change >= 0 ? 'positive' : 'negative';
      const changeSymbol = change >= 0 ? '‚ñ≤' : '‚ñº';
      
      const marketCap = fmpQuote.marketCap ? `$${(fmpQuote.marketCap / 1e12).toFixed(2)}T` : 'N/A';
      const pe = fmpQuote.pe ? fmpQuote.pe.toFixed(2) : 'N/A';
      
      const html = `
        <div class="stock-header">
          <div class="stock-title">
            <span>${fmpQuote.symbol}</span>
            <span class="company-name">${fmpQuote.name || ''}</span>
          </div>
          
          <div style="font-size: 0.9rem; color: rgba(255,255,255,0.5); margin-bottom: 20px;">
            ${fmpQuote.exchange || 'NASDAQ'} ‚Ä¢ Last Updated: ${new Date(polygonData.t).toLocaleString()}
          </div>
          
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-label">Current Price</div>
              <div class="metric-value">$${currentPrice.toFixed(2)}</div>
              <div class="metric-change ${changeClass}">
                ${changeSymbol} $${Math.abs(change).toFixed(2)} (${Math.abs(changePercent)}%)
              </div>
            </div>
            
            <div class="metric-card">
              <div class="metric-label">Day's High</div>
              <div class="metric-value">$${polygonData.h.toFixed(2)}</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-label">Day's Low</div>
              <div class="metric-value">$${polygonData.l.toFixed(2)}</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-label">Volume</div>
              <div class="metric-value" style="font-size: 1.5rem;">${polygonData.v.toLocaleString()}</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-label">Market Cap</div>
              <div class="metric-value">${marketCap}</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-label">P/E Ratio</div>
              <div class="metric-value">${pe}</div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('stockHeader').innerHTML = html;
      document.getElementById('stockHeader').style.display = 'block';
    }

    function displayChart(results, timeRange) {
      const dates = [];
      const prices = [];
      
      results.forEach(bar => {
        dates.push(new Date(bar.t));
        prices.push(bar.c);
      });
      
      if (priceChart) {
        priceChart.destroy();
      }
      
      const ctx = document.getElementById('priceChart').getContext('2d');
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Price',
            data: prices,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#667eea',
            pointHoverBorderColor: 'white',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#a8b2d1',
              bodyColor: 'white',
              borderColor: '#667eea',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (context) => '$' + context.parsed.y.toFixed(2),
                title: (context) => new Date(context[0].parsed.x).toLocaleString()
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: getTimeUnit(timeRange) },
              grid: { color: 'rgba(255, 255, 255, 0.1)', drawBorder: false },
              ticks: { color: 'rgba(255, 255, 255, 0.6)' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.1)', drawBorder: false },
              ticks: {
                color: 'rgba(255, 255, 255, 0.6)',
                callback: (value) => '$' + value.toFixed(2)
              }
            }
          },
          interaction: { intersect: false, mode: 'index' }
        }
      });
      
      document.getElementById('chartContainer').style.display = 'block';
    }

    function getTimeUnit(range) {
      const units = { '1D': 'hour', '1W': 'day', '1M': 'day', '3M': 'week', '1Y': 'month', '2Y': 'month' };
      return units[range] || 'day';
    }

    function formatCurrency(value) {
      if (!value) return 'N/A';
      if (value >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
      if (value >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(2)}M`;
      return `$${value.toLocaleString()}`;
    }

    function formatPercent(value) {
      if (!value && value !== 0) return 'N/A';
      return `${(value * 100).toFixed(2)}%`;
    }

    function displayFinancialStatements(incomeData, balanceData, cashFlowData) {
      const latest = {
        income: incomeData[0] || {},
        balance: balanceData[0] || {},
        cashFlow: cashFlowData[0] || {}
      };
      
      const html = `
        <div class="financial-card">
          <h3>üí∞ Income Statement</h3>
          <div class="financial-row">
            <span class="financial-label">Revenue</span>
            <span class="financial-value highlight">${formatCurrency(latest.income.revenue)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Cost of Revenue</span>
            <span class="financial-value">${formatCurrency(latest.income.costOfRevenue)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Gross Profit</span>
            <span class="financial-value highlight">${formatCurrency(latest.income.grossProfit)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Gross Margin</span>
            <span class="financial-value">${formatPercent(latest.income.grossProfitRatio)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Operating Expenses</span>
            <span class="financial-value">${formatCurrency(latest.income.operatingExpenses)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Operating Income</span>
            <span class="financial-value highlight">${formatCurrency(latest.income.operatingIncome)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Operating Margin</span>
            <span class="financial-value">${formatPercent(latest.income.operatingIncomeRatio)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Net Income</span>
            <span class="financial-value highlight">${formatCurrency(latest.income.netIncome)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Net Margin</span>
            <span class="financial-value">${formatPercent(latest.income.netIncomeRatio)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">EPS</span>
            <span class="financial-value">$${latest.income.eps ? latest.income.eps.toFixed(2) : 'N/A'}</span>
          </div>
        </div>

        <div class="financial-card">
          <h3>üìä Balance Sheet</h3>
          <div class="financial-row">
            <span class="financial-label">Total Assets</span>
            <span class="financial-value highlight">${formatCurrency(latest.balance.totalAssets)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Current Assets</span>
            <span class="financial-value">${formatCurrency(latest.balance.totalCurrentAssets)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Cash & Equivalents</span>
            <span class="financial-value">${formatCurrency(latest.balance.cashAndCashEquivalents)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Total Liabilities</span>
            <span class="financial-value highlight">${formatCurrency(latest.balance.totalLiabilities)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Current Liabilities</span>
            <span class="financial-value">${formatCurrency(latest.balance.totalCurrentLiabilities)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Total Debt</span>
            <span class="financial-value">${formatCurrency(latest.balance.totalDebt)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Shareholders Equity</span>
            <span class="financial-value highlight">${formatCurrency(latest.balance.totalStockholdersEquity)}</span>
          </div>
        </div>

        <div class="financial-card">
          <h3>üíµ Cash Flow Statement</h3>
          <div class="financial-row">
            <span class="financial-label">Operating Cash Flow</span>
            <span class="financial-value highlight">${formatCurrency(latest.cashFlow.operatingCashFlow)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Investing Cash Flow</span>
            <span class="financial-value">${formatCurrency(latest.cashFlow.netCashUsedForInvestingActivites)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Financing Cash Flow</span>
            <span class="financial-value">${formatCurrency(latest.cashFlow.netCashUsedProvidedByFinancingActivities)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Free Cash Flow</span>
            <span class="financial-value highlight">${formatCurrency(latest.cashFlow.freeCashFlow)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Capital Expenditure</span>
            <span class="financial-value">${formatCurrency(latest.cashFlow.capitalExpenditure)}</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Dividends Paid</span>
            <span class="financial-value">${formatCurrency(latest.cashFlow.dividendsPaid)}</span>
          </div>
        </div>
      `;
      
      document.getElementById('financialStatements').innerHTML = html;
      document.getElementById('financialsContainer').style.display = 'block';
    }

    function displayRatios(ratios) {
      if (!ratios) {
        document.getElementById('ratiosContainer').style.display = 'none';
        return;
      }
      
      const html = `
        <div class="ratio-category">
          <h4>üíé Profitability Ratios</h4>
          <div class="ratio-item">
            <span class="financial-label">Gross Profit Margin</span>
            <span class="financial-value">${formatPercent(ratios.grossProfitMargin)}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Operating Profit Margin</span>
            <span class="financial-value">${formatPercent(ratios.operatingProfitMargin)}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Net Profit Margin</span>
            <span class="financial-value">${formatPercent(ratios.netProfitMargin)}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Return on Assets (ROA)</span>
            <span class="financial-value">${formatPercent(ratios.returnOnAssets)}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Return on Equity (ROE)</span>
            <span class="financial-value">${formatPercent(ratios.returnOnEquity)}</span>
          </div>
        </div>

        <div class="ratio-category">
          <h4>üìà Valuation Ratios</h4>
          <div class="ratio-item">
            <span class="financial-label">Price to Earnings (P/E)</span>
            <span class="financial-value">${ratios.priceEarningsRatio ? ratios.priceEarningsRatio.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Price to Book (P/B)</span>
            <span class="financial-value">${ratios.priceToBookRatio ? ratios.priceToBookRatio.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Price to Sales (P/S)</span>
            <span class="financial-value">${ratios.priceToSalesRatio ? ratios.priceToSalesRatio.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">EV to EBITDA</span>
            <span class="financial-value">${ratios.enterpriseValueMultiple ? ratios.enterpriseValueMultiple.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">PEG Ratio</span>
            <span class="financial-value">${ratios.priceEarningsToGrowthRatio ? ratios.priceEarningsToGrowthRatio.toFixed(2) : 'N/A'}</span>
          </div>
        </div>

        <div class="ratio-category">
          <h4>üíß Liquidity Ratios</h4>
          <div class="ratio-item">
            <span class="financial-label">Current Ratio</span>
            <span class="financial-value">${ratios.currentRatio ? ratios.currentRatio.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Quick Ratio</span>
            <span class="financial-value">${ratios.quickRatio ? ratios.quickRatio.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Cash Ratio</span>
            <span class="financial-value">${ratios.cashRatio ? ratios.cashRatio.toFixed(2) : 'N/A'}</span>
          </div>
        </div>

        <div class="ratio-category">
          <h4>‚öñÔ∏è Leverage Ratios</h4>
          <div class="ratio-item">
            <span class="financial-label">Debt to Equity</span>
            <span class="financial-value">${ratios.debtEquityRatio ? ratios.debtEquityRatio.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Debt to Assets</span>
            <span class="financial-value">${ratios.debtRatio ? ratios.debtRatio.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Interest Coverage</span>
            <span class="financial-value">${ratios.interestCoverage ? ratios.interestCoverage.toFixed(2) : 'N/A'}</span>
          </div>
        </div>

        <div class="ratio-category">
          <h4>‚ö° Efficiency Ratios</h4>
          <div class="ratio-item">
            <span class="financial-label">Asset Turnover</span>
            <span class="financial-value">${ratios.assetTurnover ? ratios.assetTurnover.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Inventory Turnover</span>
            <span class="financial-value">${ratios.inventoryTurnover ? ratios.inventoryTurnover.toFixed(2) : 'N/A'}</span>
          </div>
          <div class="ratio-item">
            <span class="financial-label">Receivables Turnover</span>
            <span class="financial-value">${ratios.receivablesTurnover ? ratios.receivablesTurnover.toFixed(2) : 'N/A'}</span>
          </div>
        </div>
      `;
      
      document.getElementById('ratiosGrid').innerHTML = html;
      document.getElementById('ratiosContainer').style.display = 'block';
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      document.getElementById('errorDisplay').innerHTML = `
        <div class="error-msg">
          <strong>‚ùå Error:</strong> ${message}
        </div>
      `;
    }

    function hideError() {
      document.getElementById('errorDisplay').innerHTML = '';
    }
  </script>
</body>
</html>
